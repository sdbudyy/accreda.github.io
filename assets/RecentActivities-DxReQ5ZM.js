import{r as p,u as F,a as T,b as D,j as s,X as U,S as I,s as n,C,U as V,B as J,P as B,c as H,F as L}from"./index-BV0_SQyX.js";const K=()=>{const[j,S]=p.useState([]),[q,_]=p.useState(!0),[M,k]=p.useState(!1),[A,R]=p.useState(null),[E,z]=p.useState(!1),{saos:P}=F(),{skillCategories:G}=T(),g=D(),m=async(e,i=5)=>{try{console.log("ðŸ”„ Starting fetchActivities for user:",e),_(!0),console.log("ðŸ“ Fetching SAOs...");const{data:d,error:o}=await n.from("saos").select("*").eq("eit_id",e).order("updated_at",{ascending:!1}).limit(i);if(o)throw console.error("âŒ Error fetching SAOs:",o),o;console.log("ðŸ“ Recent SAOs:",(d==null?void 0:d.length)||0,"items"),console.log("ðŸ“„ Fetching documents...");const{data:l,error:r}=await n.from("documents").select("*").eq("eit_id",e).order("updated_at",{ascending:!1}).limit(i);if(r)throw console.error("âŒ Error fetching documents:",r),r;console.log("ðŸ“„ Recent documents:",(l==null?void 0:l.length)||0,"items"),console.log("ðŸŽ¯ Fetching skills...");const{data:c,error:h}=await n.from("eit_skills").select(`
          *,
          skills (
            name
          )
        `).eq("eit_id",e).not("rank","is",null).order("updated_at",{ascending:!1}).limit(i);if(h)throw console.error("âŒ Error fetching skills:",h),h;console.log("ðŸŽ¯ Recent skills:",(c==null?void 0:c.length)||0,"items"),console.log("ðŸ’¼ Fetching jobs...");const{data:u,error:f}=await n.from("jobs").select("*").eq("eit_id",e).order("updated_at",{ascending:!1}).limit(i);if(f)throw console.error("âŒ Error fetching jobs:",f),f;console.log("ðŸ’¼ Recent jobs:",(u==null?void 0:u.length)||0,"items"),console.log("ðŸ‘¥ Fetching references...");const{data:t,error:w}=await n.from("job_references").select("*").eq("eit_id",e).order("updated_at",{ascending:!1}).limit(i);if(w)throw console.error("âŒ Error fetching references:",w),w;console.log("ðŸ‘¥ Recent references:",(t==null?void 0:t.length)||0,"items"),console.log("âœ… Fetching validators...");const{data:x,error:v}=await n.from("validators").select("*").eq("eit_id",e).order("updated_at",{ascending:!1}).limit(i);if(v)throw console.error("âŒ Error fetching validators:",v),v;console.log("âœ… Recent validators:",(x==null?void 0:x.length)||0,"items"),console.log("Raw data:",{saos:d,docs:l,skills:c,jobs:u,references:t,validators:x});const N=[...(d||[]).map(a=>({id:a.id,type:"essay",title:`Updated "${a.title}" SAO`,timestamp:a.updated_at})),...(l||[]).map(a=>({id:a.id,type:"document",title:`Updated "${a.title}" document`,timestamp:a.updated_at})),...(c||[]).map(a=>{var b;return{id:a.skill_id,type:"completed",title:`Completed "${((b=a.skills)==null?void 0:b.name)||"Skill"}" skill`,timestamp:a.updated_at}}),...(u||[]).map(a=>({id:a.id,type:"job",title:`Updated "${a.title}" at ${a.company}`,timestamp:a.updated_at})),...(t||[]).map(a=>({id:a.id,type:"reference",title:`Added reference from ${a.full_name}`,timestamp:a.updated_at})),...(x||[]).map(a=>({id:a.id,type:"validator",title:`Added validator ${a.full_name}`,timestamp:a.updated_at}))].sort((a,b)=>new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime()).slice(0,i);console.log("âœ¨ Combined activities:",N.length,"items"),console.log("âœ¨ Activities details:",N),S(N)}catch(d){console.error("âŒ Error in fetchActivities:",d),S([])}finally{_(!1)}};p.useEffect(()=>{let e=!0,i=[];return(async()=>{try{console.log("ðŸ”‘ Getting current user...");const{data:{user:o}}=await n.auth.getUser();if(!o){console.error("âŒ No authenticated user found");return}console.log("âœ… User found:",o.id),console.log("ðŸ”„ Starting initial fetch..."),await m(o.id),console.log("ðŸ“¡ Setting up real-time subscriptions...");const l=n.channel("saos-changes").on("postgres_changes",{event:"*",schema:"public",table:"saos",filter:`eit_id=eq.${o.id}`},t=>{console.log("ðŸ“ SAO change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ“ SAOs subscription status:",t)}),r=n.channel("docs-changes").on("postgres_changes",{event:"*",schema:"public",table:"documents",filter:`eit_id=eq.${o.id}`},t=>{console.log("ðŸ“„ Document change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ“„ Documents subscription status:",t)}),c=n.channel("skills-changes").on("postgres_changes",{event:"*",schema:"public",table:"eit_skills",filter:`eit_id=eq.${o.id}`},t=>{console.log("ðŸŽ¯ Skill change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸŽ¯ Skills subscription status:",t)}),h=n.channel("jobs-changes").on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:`eit_id=eq.${o.id}`},t=>{console.log("ðŸ’¼ Job change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ’¼ Jobs subscription status:",t)}),u=n.channel("references-changes").on("postgres_changes",{event:"*",schema:"public",table:"job_references",filter:`eit_id=eq.${o.id}`},t=>{console.log("ðŸ‘¥ Reference change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ‘¥ References subscription status:",t)}),f=n.channel("validators-changes").on("postgres_changes",{event:"*",schema:"public",table:"validators",filter:`eit_id=eq.${o.id}`},t=>{console.log("âœ… Validator change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("âœ… Validators subscription status:",t)});i=[l,r,c,h,u,f],console.log("âœ… All subscriptions set up")}catch(o){console.error("âŒ Error setting up subscriptions:",o)}})(),()=>{console.log("ðŸ§¹ Cleaning up subscriptions"),e=!1,i.forEach(o=>{try{o.unsubscribe()}catch(l){console.error("âŒ Error unsubscribing:",l)}})}},[]);const y={completed:s.jsx(C,{size:16,className:"text-green-500"}),document:s.jsx(L,{size:16,className:"text-blue-500"}),approval:s.jsx(H,{size:16,className:"text-purple-500"}),essay:s.jsx(B,{size:16,className:"text-amber-500"}),job:s.jsx(J,{size:16,className:"text-indigo-500"}),reference:s.jsx(V,{size:16,className:"text-pink-500"}),validator:s.jsx(C,{size:16,className:"text-teal-500"})},$=e=>{const i=new Date(e),o=new Date().getTime()-i.getTime(),l=Math.floor(o/(1e3*60)),r=Math.floor(o/(1e3*60*60)),c=Math.floor(o/(1e3*60*60*24));return l<5?"Just now":l<30?`${Math.floor(l/5)*5} minutes ago`:r<1?"30 minutes ago":r===1?"1 hour ago":r<24?`${r} hours ago`:c===1?"1 day ago":`${c} days ago`},O=e=>{console.log("Handling view for activity:",e),e.type==="completed"?(g("/dashboard/skills"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("scroll-to-skill",{detail:{skillId:e.id,timestamp:Date.now()}}))},500)):e.type==="essay"?g(`/dashboard/saos?saoId=${e.id}`):e.type==="document"?(g("/dashboard/documents"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("scroll-to-document",{detail:{documentId:e.id,timestamp:Date.now()}}))},500)):(e.type==="job"||e.type==="reference"||e.type==="validator")&&(sessionStorage.setItem("pendingScroll",JSON.stringify({itemId:e.id,itemType:e.type})),g("/dashboard/references"))};return q?s.jsx("div",{className:"space-y-4",children:[...Array(3)].map((e,i)=>s.jsxs("div",{className:"flex items-start space-x-3 animate-pulse",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-200 mt-0.5 w-8 h-8"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"h-4 bg-slate-200 rounded w-3/4 mb-2"}),s.jsx("div",{className:"h-3 bg-slate-200 rounded w-1/4"})]})]},i))}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-4",children:[j.length>0?j.slice(0,5).map(e=>s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-100 mt-0.5",children:y[e.type]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm text-slate-800",children:e.title}),s.jsxs("div",{className:"flex items-center mt-1",children:[e.user&&s.jsx("span",{className:"text-xs font-medium text-slate-700 mr-2",children:e.user}),s.jsx("span",{className:"text-xs text-slate-500",children:$(e.timestamp)})]})]}),s.jsx("button",{className:"ml-2 px-3 py-1 text-xs bg-amber-100 text-amber-700 hover:bg-amber-200",onClick:()=>O(e),children:"View"})]},e.id)):s.jsx("div",{className:"text-center py-4 text-slate-500",children:"No recent activities"}),s.jsx("button",{className:"w-full text-center py-2 text-lg text-teal-600 hover:underline font-medium",onClick:()=>g("/dashboard/activities"),children:"View more activities"})]}),M&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden",children:[s.jsxs("div",{className:"p-4 border-b border-slate-200 flex justify-between items-center",children:[s.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:"Recent Activities"}),s.jsx("button",{onClick:()=>k(!1),className:"p-2 hover:bg-slate-100 rounded-lg",children:s.jsx(U,{size:20,className:"text-slate-500"})})]}),s.jsx("div",{className:"p-4 overflow-y-auto max-h-[calc(80vh-4rem)]",children:s.jsx("div",{className:"space-y-4",children:j.map(e=>s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-100 mt-0.5",children:y[e.type]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm text-slate-800",children:e.title}),s.jsxs("div",{className:"flex items-center mt-1",children:[e.user&&s.jsx("span",{className:"text-xs font-medium text-slate-700 mr-2",children:e.user}),s.jsx("span",{className:"text-xs text-slate-500",children:$(e.timestamp)})]})]}),s.jsx("button",{className:"ml-2 px-3 py-1 text-xs bg-amber-100 text-amber-700 hover:bg-amber-200",onClick:()=>{O(e),k(!1)},children:"View"})]},e.id))})})]})}),E&&A&&s.jsx(I,{isOpen:E,onClose:()=>{z(!1),R(null)},editSAO:A})]})};export{K as default};
