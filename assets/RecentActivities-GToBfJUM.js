import{c as F,r as p,u as T,a as D,b as I,j as s,X as V,S as H,s as n,C as O,U as J,B as L,P as B,F as P}from"./index-Dor-hwPx.js";/**
 * @license lucide-react v0.323.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=F("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]),W=()=>{const[j,_]=p.useState([]),[q,k]=p.useState(!0),[M,w]=p.useState(!1),[y,R]=p.useState(null),[A,U]=p.useState(!1),{saos:X}=T(),{skillCategories:K}=D(),x=I(),m=async(e,l=5)=>{try{console.log("ðŸ”„ Starting fetchActivities for user:",e),k(!0),console.log("ðŸ“ Fetching SAOs...");const{data:d,error:o}=await n.from("saos").select("*").eq("user_id",e).order("updated_at",{ascending:!1}).limit(l);if(o)throw console.error("âŒ Error fetching SAOs:",o),o;console.log("ðŸ“ Recent SAOs:",(d==null?void 0:d.length)||0,"items"),console.log("ðŸ“„ Fetching documents...");const{data:i,error:r}=await n.from("documents").select("*").eq("user_id",e).order("updated_at",{ascending:!1}).limit(l);if(r)throw console.error("âŒ Error fetching documents:",r),r;console.log("ðŸ“„ Recent documents:",(i==null?void 0:i.length)||0,"items"),console.log("ðŸŽ¯ Fetching skills...");const{data:c,error:g}=await n.from("user_skills").select(`
          *,
          skills (
            name
          )
        `).eq("user_id",e).not("rank","is",null).order("updated_at",{ascending:!1}).limit(l);if(g)throw console.error("âŒ Error fetching skills:",g),g;console.log("ðŸŽ¯ Recent skills:",(c==null?void 0:c.length)||0,"items"),console.log("ðŸ’¼ Fetching jobs...");const{data:u,error:h}=await n.from("jobs").select("*").eq("user_id",e).order("updated_at",{ascending:!1}).limit(l);if(h)throw console.error("âŒ Error fetching jobs:",h),h;console.log("ðŸ’¼ Recent jobs:",(u==null?void 0:u.length)||0,"items"),console.log("ðŸ‘¥ Fetching references...");const{data:t,error:v}=await n.from("job_references").select("*").eq("user_id",e).order("updated_at",{ascending:!1}).limit(l);if(v)throw console.error("âŒ Error fetching references:",v),v;console.log("ðŸ‘¥ Recent references:",(t==null?void 0:t.length)||0,"items"),console.log("âœ… Fetching validators...");const{data:f,error:N}=await n.from("validators").select("*").eq("user_id",e).order("updated_at",{ascending:!1}).limit(l);if(N)throw console.error("âŒ Error fetching validators:",N),N;console.log("âœ… Recent validators:",(f==null?void 0:f.length)||0,"items"),console.log("Raw data:",{saos:d,docs:i,skills:c,jobs:u,references:t,validators:f});const S=[...(d||[]).map(a=>({id:a.id,type:"essay",title:`Updated "${a.title}" SAO`,timestamp:a.updated_at})),...(i||[]).map(a=>({id:a.id,type:"document",title:`Updated "${a.title}" document`,timestamp:a.updated_at})),...(c||[]).map(a=>{var b;return{id:a.skill_id,type:"completed",title:`Completed "${((b=a.skills)==null?void 0:b.name)||"Skill"}" skill`,timestamp:a.updated_at}}),...(u||[]).map(a=>({id:a.id,type:"job",title:`Updated "${a.title}" at ${a.company}`,timestamp:a.updated_at})),...(t||[]).map(a=>({id:a.id,type:"reference",title:`Added reference from ${a.full_name}`,timestamp:a.updated_at})),...(f||[]).map(a=>({id:a.id,type:"validator",title:`Added validator ${a.full_name}`,timestamp:a.updated_at}))].sort((a,b)=>new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime()).slice(0,l);console.log("âœ¨ Combined activities:",S.length,"items"),console.log("âœ¨ Activities details:",S),_(S)}catch(d){console.error("âŒ Error in fetchActivities:",d),_([])}finally{k(!1)}};p.useEffect(()=>{let e=!0,l=[];return(async()=>{try{console.log("ðŸ”‘ Getting current user...");const{data:{user:o}}=await n.auth.getUser();if(!o){console.error("âŒ No authenticated user found");return}console.log("âœ… User found:",o.id),console.log("ðŸ”„ Starting initial fetch..."),await m(o.id),console.log("ðŸ“¡ Setting up real-time subscriptions...");const i=n.channel("saos-changes").on("postgres_changes",{event:"*",schema:"public",table:"saos",filter:`user_id=eq.${o.id}`},t=>{console.log("ðŸ“ SAO change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ“ SAOs subscription status:",t)}),r=n.channel("docs-changes").on("postgres_changes",{event:"*",schema:"public",table:"documents",filter:`user_id=eq.${o.id}`},t=>{console.log("ðŸ“„ Document change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ“„ Documents subscription status:",t)}),c=n.channel("skills-changes").on("postgres_changes",{event:"*",schema:"public",table:"user_skills",filter:`user_id=eq.${o.id}`},t=>{console.log("ðŸŽ¯ Skill change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸŽ¯ Skills subscription status:",t)}),g=n.channel("jobs-changes").on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:`user_id=eq.${o.id}`},t=>{console.log("ðŸ’¼ Job change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ’¼ Jobs subscription status:",t)}),u=n.channel("references-changes").on("postgres_changes",{event:"*",schema:"public",table:"job_references",filter:`user_id=eq.${o.id}`},t=>{console.log("ðŸ‘¥ Reference change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("ðŸ‘¥ References subscription status:",t)}),h=n.channel("validators-changes").on("postgres_changes",{event:"*",schema:"public",table:"validators",filter:`user_id=eq.${o.id}`},t=>{console.log("âœ… Validator change detected:",t),e&&m(o.id)}).subscribe(t=>{console.log("âœ… Validators subscription status:",t)});l=[i,r,c,g,u,h],console.log("âœ… All subscriptions set up")}catch(o){console.error("âŒ Error setting up subscriptions:",o)}})(),()=>{console.log("ðŸ§¹ Cleaning up subscriptions"),e=!1,l.forEach(o=>{try{o.unsubscribe()}catch(i){console.error("âŒ Error unsubscribing:",i)}})}},[]);const E={completed:s.jsx(O,{size:16,className:"text-green-500"}),document:s.jsx(P,{size:16,className:"text-blue-500"}),approval:s.jsx(G,{size:16,className:"text-purple-500"}),essay:s.jsx(B,{size:16,className:"text-amber-500"}),job:s.jsx(L,{size:16,className:"text-indigo-500"}),reference:s.jsx(J,{size:16,className:"text-pink-500"}),validator:s.jsx(O,{size:16,className:"text-teal-500"})},$=e=>{const l=new Date(e),o=new Date().getTime()-l.getTime(),i=Math.floor(o/(1e3*60)),r=Math.floor(o/(1e3*60*60)),c=Math.floor(o/(1e3*60*60*24));return i<5?"Just now":i<30?`${Math.floor(i/5)*5} minutes ago`:r<1?"30 minutes ago":r===1?"1 hour ago":r<24?`${r} hours ago`:c===1?"1 day ago":`${c} days ago`},C=e=>{console.log("Handling view for activity:",e),e.type==="completed"?(x("/dashboard/skills"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("scroll-to-skill",{detail:{skillId:e.id,timestamp:Date.now()}}))},500)):e.type==="essay"?x(`/dashboard/saos?saoId=${e.id}`):e.type==="document"?(x("/dashboard/documents"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("scroll-to-document",{detail:{documentId:e.id,timestamp:Date.now()}}))},500)):(e.type==="job"||e.type==="reference"||e.type==="validator")&&(sessionStorage.setItem("pendingScroll",JSON.stringify({itemId:e.id,itemType:e.type})),x("/dashboard/references"))},z=async()=>{const{data:{user:e}}=await n.auth.getUser();e&&(await m(e.id,10),w(!0))};return q?s.jsx("div",{className:"space-y-4",children:[...Array(3)].map((e,l)=>s.jsxs("div",{className:"flex items-start space-x-3 animate-pulse",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-200 mt-0.5 w-8 h-8"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"h-4 bg-slate-200 rounded w-3/4 mb-2"}),s.jsx("div",{className:"h-3 bg-slate-200 rounded w-1/4"})]})]},l))}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-4",children:[j.length>0?j.slice(0,5).map(e=>s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-100 mt-0.5",children:E[e.type]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm text-slate-800",children:e.title}),s.jsxs("div",{className:"flex items-center mt-1",children:[e.user&&s.jsx("span",{className:"text-xs font-medium text-slate-700 mr-2",children:e.user}),s.jsx("span",{className:"text-xs text-slate-500",children:$(e.timestamp)})]})]}),s.jsx("button",{className:"ml-2 px-3 py-1 text-xs bg-teal-100 text-teal-700 rounded hover:bg-teal-200",onClick:()=>C(e),children:"View"})]},e.id)):s.jsx("div",{className:"text-center py-4 text-slate-500",children:"No recent activities"}),s.jsx("button",{className:"w-full text-center py-2 text-sm text-teal-600 hover:text-teal-700 mt-2",onClick:z,children:"View more activities"})]}),M&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden",children:[s.jsxs("div",{className:"p-4 border-b border-slate-200 flex justify-between items-center",children:[s.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:"Recent Activities"}),s.jsx("button",{onClick:()=>w(!1),className:"p-2 hover:bg-slate-100 rounded-lg",children:s.jsx(V,{size:20,className:"text-slate-500"})})]}),s.jsx("div",{className:"p-4 overflow-y-auto max-h-[calc(80vh-4rem)]",children:s.jsx("div",{className:"space-y-4",children:j.map(e=>s.jsxs("div",{className:"flex items-start space-x-3",children:[s.jsx("div",{className:"p-2 rounded-full bg-slate-100 mt-0.5",children:E[e.type]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm text-slate-800",children:e.title}),s.jsxs("div",{className:"flex items-center mt-1",children:[e.user&&s.jsx("span",{className:"text-xs font-medium text-slate-700 mr-2",children:e.user}),s.jsx("span",{className:"text-xs text-slate-500",children:$(e.timestamp)})]})]}),s.jsx("button",{className:"ml-2 px-3 py-1 text-xs bg-teal-100 text-teal-700 rounded hover:bg-teal-200",onClick:()=>{C(e),w(!1)},children:"View"})]},e.id))})})]})}),A&&y&&s.jsx(H,{isOpen:A,onClose:()=>{U(!1),R(null)},editSAO:y})]})};export{W as default};
